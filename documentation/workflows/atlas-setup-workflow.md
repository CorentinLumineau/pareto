# Atlas Setup Workflow

> **Declarative database migrations with schema diffing (Prisma-like DX)**

```
╔════════════════════════════════════════════════════════════════════════════╗
║  EPIC: Atlas Database Migration Setup                                       ║
║  Total Effort: 5-6 hours                                                    ║
║  Status: Ready for Implementation                                           ║
║  Dependencies: Foundation ✅, Devcontainer ✅                               ║
╚════════════════════════════════════════════════════════════════════════════╝
```

## Overview

Set up Atlas for declarative database schema management:
- **Declarative schema** - Define desired state in `schema.sql`
- **Auto-diffing** - Atlas generates migrations automatically
- **Migration linting** - Catch dangerous changes before applying
- **TimescaleDB support** - For price history hypertables

## Target Structure

```
apps/api/
├── atlas.hcl              # Atlas configuration
├── schema.sql             # Declarative schema (source of truth)
├── migrations/            # Auto-generated by Atlas
│   ├── 20241201000001_init.sql
│   └── atlas.sum          # Integrity checksum
├── cmd/
│   └── api/main.go
└── internal/
    └── database/
        ├── postgres.go    # Connection (existing)
        └── migrate.go     # Migration helpers
```

---

## Phase 1: Atlas Installation & Configuration (1h)

### Task 1.1: Add Atlas to Devcontainer

```bash
/x:implement "Add Atlas CLI installation to devcontainer Dockerfile. Install via curl from atlasgo.sh. Add atlas to PATH. Location: .devcontainer/Dockerfile"
```

**Deliverables:**
- Updated `.devcontainer/Dockerfile` with Atlas installation

**Acceptance Criteria:**
- `atlas version` works inside devcontainer
- Atlas available in PATH for all users

---

### Task 1.2: Create Atlas Configuration

```bash
/x:implement "Create atlas.hcl configuration file for PostgreSQL 18 with TimescaleDB. Configure dev-url to use Docker postgres, set migration directory, enable destructive change protection. Location: apps/api/atlas.hcl"
```

**Deliverables:**
- `apps/api/atlas.hcl`

**Configuration:**
```hcl
# apps/api/atlas.hcl
variable "database_url" {
  type    = string
  default = getenv("DATABASE_URL")
}

env "local" {
  src = "file://schema.sql"
  url = var.database_url
  dev = "docker://postgres/18/dev?search_path=public"

  migration {
    dir = "file://migrations"
  }

  diff {
    skip {
      drop_column = true  # Prevent accidental drops
    }
  }

  lint {
    destructive {
      error = true  # Block destructive changes
    }
  }
}

env "ci" {
  src = "file://schema.sql"
  url = var.database_url
  dev = "docker://postgres/18/dev?search_path=public"

  migration {
    dir    = "file://migrations"
    format = atlas
  }
}
```

---

### Task 1.3: Add Makefile Commands

```bash
/x:implement "Add Atlas database commands to root Makefile: db:diff, db:apply, db:status, db:lint, db:new. Commands should work from project root and target apps/api/. Location: Makefile"
```

**Deliverables:**
- Updated `Makefile` with Atlas commands

**Commands:**
```makefile
# Database migrations (Atlas)
db\:diff:        ## Generate migration from schema changes
db\:apply:       ## Apply pending migrations
db\:status:      ## Show migration status
db\:lint:        ## Lint migrations for issues
db\:new:         ## Create new empty migration
db\:reset:       ## Reset database (dangerous!)
```

---

## Phase 2: Declarative Schema (2h)

### Task 2.1: Create Complete Schema

```bash
/x:implement "Create declarative schema.sql for Pareto Comparator with tables: categories, retailers, products (JSONB attributes), variants (EAN, color, storage), offers (prices), and price_history (TimescaleDB hypertable). Include all indexes, constraints, and triggers. Use UUID v4 for IDs. Location: apps/api/schema.sql"
```

**Deliverables:**
- `apps/api/schema.sql`

**Schema Overview:**
```sql
-- Extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "timescaledb";

-- Categories (smartphones, tablets, etc.)
CREATE TABLE categories (...)

-- Retailers (amazon_fr, fnac, etc.)
CREATE TABLE retailers (...)

-- Products (from brand websites)
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    category_id UUID REFERENCES categories(id),
    name TEXT NOT NULL,
    slug TEXT NOT NULL UNIQUE,
    brand TEXT NOT NULL,
    model TEXT NOT NULL,
    ean TEXT UNIQUE,
    sku TEXT,
    image_url TEXT,
    attributes JSONB DEFAULT '{}',
    source_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Variants (color/storage combinations)
CREATE TABLE variants (...)

-- Offers (marketplace prices)
CREATE TABLE offers (...)

-- Price History (TimescaleDB)
CREATE TABLE price_history (...)
SELECT create_hypertable('price_history', 'time');
```

---

### Task 2.2: Generate Initial Migration

```bash
/x:implement "Generate initial Atlas migration from schema.sql. Run atlas migrate diff init to create the first migration. Verify the generated SQL is correct. Location: apps/api/migrations/"
```

**Deliverables:**
- `apps/api/migrations/20241201000001_init.sql`
- `apps/api/migrations/atlas.sum`

**Commands:**
```bash
cd apps/api
atlas migrate diff init \
  --env local \
  --to file://schema.sql
```

---

### Task 2.3: Apply and Verify Migration

```bash
/x:implement "Apply initial migration to local PostgreSQL database. Verify all tables created correctly with proper indexes and constraints. Test TimescaleDB hypertable creation. Location: apps/api/"
```

**Verification:**
```bash
# Apply migration
atlas migrate apply --env local

# Check status
atlas migrate status --env local

# Verify tables
psql $DATABASE_URL -c "\dt"
psql $DATABASE_URL -c "\d products"
```

---

## Phase 3: Go Integration (1.5h)

### Task 3.1: Create Migration Helper

```bash
/x:implement "Create Go migration helper that can apply Atlas migrations programmatically on application startup (optional). Use atlasexec Go client. Include skip-if-current check. Location: apps/api/internal/database/migrate.go"
```

**Deliverables:**
- `apps/api/internal/database/migrate.go`

**Example:**
```go
package database

import (
    "context"
    "ariga.io/atlas-go-sdk/atlasexec"
)

func ApplyMigrations(ctx context.Context, dbURL string) error {
    client, err := atlasexec.NewClient(".", "atlas")
    if err != nil {
        return err
    }

    _, err = client.MigrateApply(ctx, &atlasexec.MigrateApplyParams{
        URL:    dbURL,
        DirURL: "file://migrations",
    })
    return err
}
```

---

### Task 3.2: Update Domain Types

```bash
/x:implement "Update Go domain types in apps/api/internal/catalog/domain/ to match the new schema. Ensure Product, Variant, Offer, Retailer, Category structs align with database schema. Add proper JSON and DB tags. Location: apps/api/internal/catalog/domain/"
```

**Deliverables:**
- Updated `apps/api/internal/catalog/domain/product.go`
- New `apps/api/internal/catalog/domain/variant.go`
- New `apps/api/internal/catalog/domain/offer.go`
- Updated `apps/api/internal/catalog/domain/retailer.go`
- Updated `apps/api/internal/catalog/domain/category.go`

---

### Task 3.3: Update Repository Interface

```bash
/x:implement "Update ProductRepository interface and add VariantRepository, OfferRepository interfaces to support new schema. Include methods for EAN lookup, JSONB attribute queries, and batch operations. Location: apps/api/internal/catalog/repository/"
```

**Deliverables:**
- Updated `apps/api/internal/catalog/repository/interface.go`

---

## Phase 4: Documentation & Testing (1h)

### Task 4.1: Update Development Docs

```bash
/x:implement "Update documentation/development/README.md with Atlas workflow: how to modify schema, generate migrations, apply changes. Add troubleshooting section. Location: documentation/development/"
```

**Deliverables:**
- Updated `documentation/development/README.md`
- New `documentation/development/database.md`

---

### Task 4.2: Test Full Workflow

```bash
/x:verify "Test complete Atlas workflow: 1) Modify schema.sql (add column), 2) Run atlas migrate diff, 3) Review generated migration, 4) Apply migration, 5) Verify change in database"
```

**Verification Steps:**
1. Add a test column to schema.sql
2. Run `make db:diff name=add_test_column`
3. Inspect generated migration file
4. Run `make db:apply`
5. Verify column exists in database
6. Revert: remove column from schema.sql
7. Run diff again to generate DROP migration
8. Clean up test migration

---

## Dependency Graph

```
┌─────────────────────────────────────────────────────────────┐
│                     ATLAS SETUP                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   [Dockerfile]                                              │
│       │                                                     │
│       ▼                                                     │
│   [atlas.hcl] ◄──────────────────────────┐                 │
│       │                                   │                 │
│       ▼                                   │                 │
│   [schema.sql] ──────────────────────────┤                 │
│       │                                   │                 │
│       ▼                                   │                 │
│   [atlas migrate diff] ◄─────────────────┘                 │
│       │                                                     │
│       ▼                                                     │
│   [migrations/*.sql]                                        │
│       │                                                     │
│       ├──────────────┬──────────────────┐                  │
│       ▼              ▼                  ▼                  │
│   [atlas apply]  [Go types]        [Makefile]              │
│       │              │                  │                  │
│       ▼              ▼                  │                  │
│   [PostgreSQL]   [Repository]          │                  │
│                      │                  │                  │
│                      └──────────────────┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Execution Order

```bash
# Phase 1: Installation (30 min)
/x:implement "Add Atlas CLI to devcontainer Dockerfile..."
/x:implement "Create atlas.hcl configuration..."
/x:implement "Add Atlas commands to Makefile..."

# Phase 2: Schema (1.5h)
/x:implement "Create declarative schema.sql..."
# Then manually:
cd apps/api && atlas migrate diff init --env local

# Phase 3: Go Integration (1.5h)
/x:implement "Create Go migration helper..."
/x:implement "Update Go domain types..."
/x:implement "Update repository interfaces..."

# Phase 4: Verification (30 min)
/x:verify "Test complete Atlas workflow..."
```

---

## Daily Workflow After Setup

```bash
# 1. Edit schema (add table/column/index)
vim apps/api/schema.sql

# 2. Generate migration
make db:diff name=add_user_preferences

# 3. Review generated SQL
cat apps/api/migrations/*_add_user_preferences.sql

# 4. Lint for issues
make db:lint

# 5. Apply to local DB
make db:apply

# 6. Commit both schema.sql AND migration
git add apps/api/schema.sql apps/api/migrations/
git commit -m "feat: add user preferences table"
```

---

## Success Criteria

| Criteria | Status |
|----------|--------|
| Atlas CLI installed in devcontainer | ⬜ |
| atlas.hcl configured for local/ci | ⬜ |
| schema.sql with all tables | ⬜ |
| Initial migration generated | ⬜ |
| Migration applies successfully | ⬜ |
| Go types match schema | ⬜ |
| Makefile commands work | ⬜ |
| Documentation updated | ⬜ |

---

**Created**: 2025-12-01
**Related**: [Scraper Initiative](./scraper-initiative-workflow.md)
**Back to**: [MASTERPLAN](../milestones/MASTERPLAN.md)
